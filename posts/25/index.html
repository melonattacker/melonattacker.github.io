<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>[TsukuCTF 2022] My own writeup - yuasa's blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="TsukuCTF 2022が10/22 12:20 - 10/23 18:00(JST)の日程で開催されました. webを解いていたので, そのwriteupを以下に記します.
[web] bughunter(86 solves) [web] viewer(8 solves, not solved) [web] bughunter(86 solves) 問題文 天才ハッカーのつくし君は、どんなサイトの脆弱性でも見つけることができます。 あなたも彼のようにこのサイトの脆弱性を見つけることができますか？ 見つけたら私たちに報告してください。 ※ディレクトリの総当たりなどは禁止されています。本問題の解決には、多数のリクエストは不要です。
http://133.130.103.51:31415
解法 問題にRFC9116がタグ付けされています. RFC9116で検索すると, こちらのページが見つかります.
RFC9116は、組織が脆弱性の開示方法を説明し、セキュリティ研究者などが発見した脆弱性を報告しやすくするために定義されたものです。この仕組みは単純で、必要な情報を記載した「security.txt」ファイルをWebサイトの「/.well-known/」パスの下に公開することを要求しています。「security.txt」には次の項目が記述されます。
実際に/.well-known/security.txtをGETすると, flagが書かれていました.
$ curl &#34;http://133.130.103.51:31415/.well-known/security.txt&#34; Contact: TsukuCTF22{y0u_c4n_c47ch_bu65_4ll_y34r_r0und_1n_7h3_1n73rn37} Expires: 2022-10-20T15:00:00.000Z Preferred-Languages: ja, en% [web] viewer(8 solves, not solved) 問題文 Writeups for TsukuCTF21 have been published. Check them out if you&rsquo;d like!
URL
解法 解けませんでした. 配布コードのapp.pyは以下のようになっています.
from flask import ( Flask, abort, make_response, render_template, request, redirect ) import redis import pycurl from io import BytesIO import traceback import uuid import json app = Flask(__name__) # initialization redis = redis."><meta property="og:image" content><meta property="og:title" content="[TsukuCTF 2022] My own writeup"><meta property="og:description" content="TsukuCTF 2022が10/22 12:20 - 10/23 18:00(JST)の日程で開催されました. webを解いていたので, そのwriteupを以下に記します.
[web] bughunter(86 solves) [web] viewer(8 solves, not solved) [web] bughunter(86 solves) 問題文 天才ハッカーのつくし君は、どんなサイトの脆弱性でも見つけることができます。 あなたも彼のようにこのサイトの脆弱性を見つけることができますか？ 見つけたら私たちに報告してください。 ※ディレクトリの総当たりなどは禁止されています。本問題の解決には、多数のリクエストは不要です。
http://133.130.103.51:31415
解法 問題にRFC9116がタグ付けされています. RFC9116で検索すると, こちらのページが見つかります.
RFC9116は、組織が脆弱性の開示方法を説明し、セキュリティ研究者などが発見した脆弱性を報告しやすくするために定義されたものです。この仕組みは単純で、必要な情報を記載した「security.txt」ファイルをWebサイトの「/.well-known/」パスの下に公開することを要求しています。「security.txt」には次の項目が記述されます。
実際に/.well-known/security.txtをGETすると, flagが書かれていました.
$ curl &#34;http://133.130.103.51:31415/.well-known/security.txt&#34; Contact: TsukuCTF22{y0u_c4n_c47ch_bu65_4ll_y34r_r0und_1n_7h3_1n73rn37} Expires: 2022-10-20T15:00:00.000Z Preferred-Languages: ja, en% [web] viewer(8 solves, not solved) 問題文 Writeups for TsukuCTF21 have been published. Check them out if you&rsquo;d like!
URL
解法 解けませんでした. 配布コードのapp.pyは以下のようになっています.
from flask import ( Flask, abort, make_response, render_template, request, redirect ) import redis import pycurl from io import BytesIO import traceback import uuid import json app = Flask(__name__) # initialization redis = redis."><meta property="og:type" content="article"><meta property="og:url" content="/posts/25/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-24T00:11:07+09:00"><meta property="article:modified_time" content="2022-10-24T00:11:07+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="[TsukuCTF 2022] My own writeup"><meta name=twitter:description content="TsukuCTF 2022が10/22 12:20 - 10/23 18:00(JST)の日程で開催されました. webを解いていたので, そのwriteupを以下に記します.
[web] bughunter(86 solves) [web] viewer(8 solves, not solved) [web] bughunter(86 solves) 問題文 天才ハッカーのつくし君は、どんなサイトの脆弱性でも見つけることができます。 あなたも彼のようにこのサイトの脆弱性を見つけることができますか？ 見つけたら私たちに報告してください。 ※ディレクトリの総当たりなどは禁止されています。本問題の解決には、多数のリクエストは不要です。
http://133.130.103.51:31415
解法 問題にRFC9116がタグ付けされています. RFC9116で検索すると, こちらのページが見つかります.
RFC9116は、組織が脆弱性の開示方法を説明し、セキュリティ研究者などが発見した脆弱性を報告しやすくするために定義されたものです。この仕組みは単純で、必要な情報を記載した「security.txt」ファイルをWebサイトの「/.well-known/」パスの下に公開することを要求しています。「security.txt」には次の項目が記述されます。
実際に/.well-known/security.txtをGETすると, flagが書かれていました.
$ curl &#34;http://133.130.103.51:31415/.well-known/security.txt&#34; Contact: TsukuCTF22{y0u_c4n_c47ch_bu65_4ll_y34r_r0und_1n_7h3_1n73rn37} Expires: 2022-10-20T15:00:00.000Z Preferred-Languages: ja, en% [web] viewer(8 solves, not solved) 問題文 Writeups for TsukuCTF21 have been published. Check them out if you&rsquo;d like!
URL
解法 解けませんでした. 配布コードのapp.pyは以下のようになっています.
from flask import ( Flask, abort, make_response, render_template, request, redirect ) import redis import pycurl from io import BytesIO import traceback import uuid import json app = Flask(__name__) # initialization redis = redis."><script src=/js/feather.min.js></script>
<link href=/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link id=darkModeStyle rel=stylesheet type=text/css href=/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"><link rel=icon type=image/png href=/images/favicon.ico></head><body><div class=content><header><div class=main><a href=/>yuasa's blog</a></div><nav><a href=/>Home</a>
<a href=/posts>Posts</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>[TsukuCTF 2022] My own writeup</h1><div class=meta>Posted on Oct 24, 2022</div></div><nav id=TableOfContents><ol><li><a href=#web-bughunter86-solves>[web] bughunter(86 solves)</a><ol><li><a href=#問題文>問題文</a></li><li><a href=#解法>解法</a></li></ol></li><li><a href=#web-viewer8-solves-not-solved>[web] viewer(8 solves, not solved)</a><ol><li><a href=#問題文-1>問題文</a></li><li><a href=#解法-1>解法</a></li></ol></li><li><a href=#感想>感想</a></li></ol></nav><section class=body><p>TsukuCTF 2022が10/22 12:20 - 10/23 18:00(JST)の日程で開催されました. webを解いていたので, そのwriteupを以下に記します.</p><ul><li>[web] bughunter(86 solves)</li><li>[web] viewer(8 solves, not solved)</li></ul><h1 id=web-bughunter86-solves>[web] bughunter(86 solves)</h1><h2 id=問題文>問題文</h2><blockquote><p>天才ハッカーのつくし君は、どんなサイトの脆弱性でも見つけることができます。 あなたも彼のようにこのサイトの脆弱性を見つけることができますか？ 見つけたら私たちに報告してください。
※ディレクトリの総当たりなどは禁止されています。本問題の解決には、多数のリクエストは不要です。</p></blockquote><p>http://133.130.103.51:31415</p><h2 id=解法>解法</h2><p>問題に<code>RFC9116</code>がタグ付けされています. <code>RFC9116</code>で検索すると, こちらの<a href=https://blogs.jpcert.or.jp/ja/2022/08/rfc9116-introduction.html>ページ</a>が見つかります.</p><blockquote><p>RFC9116は、組織が脆弱性の開示方法を説明し、セキュリティ研究者などが発見した脆弱性を報告しやすくするために定義されたものです。この仕組みは単純で、必要な情報を記載した「security.txt」ファイルをWebサイトの「/.well-known/」パスの下に公開することを要求しています。「security.txt」には次の項目が記述されます。</p></blockquote><p>実際に<code>/.well-known/security.txt</code>をGETすると, flagが書かれていました.</p><pre tabindex=0><code>$ curl &#34;http://133.130.103.51:31415/.well-known/security.txt&#34;
Contact: TsukuCTF22{y0u_c4n_c47ch_bu65_4ll_y34r_r0und_1n_7h3_1n73rn37}
Expires: 2022-10-20T15:00:00.000Z
Preferred-Languages: ja, en%     
</code></pre><h1 id=web-viewer8-solves-not-solved>[web] viewer(8 solves, not solved)</h1><h2 id=問題文-1>問題文</h2><p>Writeups for TsukuCTF21 have been published. Check them out if you&rsquo;d like!</p><p><a href=https://tsukuctf.sechack365.com/viewer>URL</a></p><h2 id=解法-1>解法</h2><p>解けませんでした. 配布コードの<code>app.py</code>は以下のようになっています.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.py data-lang=:.py><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    Flask,
</span></span><span style=display:flex><span>    abort,
</span></span><span style=display:flex><span>    make_response,
</span></span><span style=display:flex><span>    render_template,
</span></span><span style=display:flex><span>    request,
</span></span><span style=display:flex><span>    redirect
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> redis
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pycurl
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> io <span style=color:#f92672>import</span> BytesIO
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> traceback
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> uuid
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># initialization</span>
</span></span><span style=display:flex><span>redis <span style=color:#f92672>=</span> redis<span style=color:#f92672>.</span>Redis(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;redis&#39;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>6379</span>, db<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>flag <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TsukuCTF22{dummy flag}&#34;</span> <span style=color:#75715e># the flag is replaced a real flag in a production environment.</span>
</span></span><span style=display:flex><span>id <span style=color:#f92672>=</span> str(uuid<span style=color:#f92672>.</span>uuid4())
</span></span><span style=display:flex><span>redis<span style=color:#f92672>.</span>set(id, json<span style=color:#f92672>.</span>dumps({<span style=color:#e6db74>&#34;id&#34;</span>: id, <span style=color:#e6db74>&#34;name&#34;</span>: flag}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># only &#39;http&#39; and &#39;https&#39; should have been allowed, right?</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ref: https://everything.curl.dev/cmdline/urls/scheme#supported-schemes</span>
</span></span><span style=display:flex><span>blacklist_of_scheme <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;dict&#39;</span>, <span style=color:#e6db74>&#39;file&#39;</span>, <span style=color:#e6db74>&#39;ftp&#39;</span>, <span style=color:#e6db74>&#39;gopher&#39;</span>, <span style=color:#e6db74>&#39;imap&#39;</span>, <span style=color:#e6db74>&#39;ldap&#39;</span>, <span style=color:#e6db74>&#39;mqtt&#39;</span>, <span style=color:#e6db74>&#39;pop3&#39;</span>, <span style=color:#e6db74>&#39;rtmp&#39;</span>, <span style=color:#e6db74>&#39;rtsp&#39;</span>, <span style=color:#e6db74>&#39;scp&#39;</span>, <span style=color:#e6db74>&#39;smb&#39;</span>, <span style=color:#e6db74>&#39;smtp&#39;</span>, <span style=color:#e6db74>&#39;telnet&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>url_sanitizer</span>(uri: str) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(uri) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>or</span> any([scheme <span style=color:#f92672>in</span> uri <span style=color:#66d9ef>for</span> scheme <span style=color:#f92672>in</span> blacklist_of_scheme]):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;https://fans.sechack365.com&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> uri
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># a response is also sanitized just in case because the flag is super sensitive information.</span>
</span></span><span style=display:flex><span>blacklist_in_response <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;TsukuCTF22&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>response_sanitizer</span>(body: str) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> any([scheme <span style=color:#f92672>in</span> body <span style=color:#66d9ef>for</span> scheme <span style=color:#f92672>in</span> blacklist_in_response]):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;SANITIZED: a sensitive data is included!&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> body
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/&lt;path:path&gt;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>missing_handler</span>(path):
</span></span><span style=display:flex><span>    abort(<span style=color:#ae81ff>404</span>, <span style=color:#e6db74>&#34;ページが見つかりません&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/&#34;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;POST&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>route_index</span>():
</span></span><span style=display:flex><span>    session_id <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>cookies<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;__SESSION_ID&#39;</span>)
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> session_id <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        res<span style=color:#f92672>=</span> redis<span style=color:#f92672>.</span>get(session_id)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> res <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            user <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(res)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;user: </span><span style=color:#e6db74>{</span>user<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            name <span style=color:#f92672>=</span> user[<span style=color:#e6db74>&#34;name&#34;</span>]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> name <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>and</span> <span style=color:#e6db74>&#34;TsukuCTF22{&#34;</span> <span style=color:#f92672>in</span> name:
</span></span><span style=display:flex><span>                name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tsukushi&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redirect(<span style=color:#e6db74>&#39;/register&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> request<span style=color:#f92672>.</span>method <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;POST&#34;</span>:
</span></span><span style=display:flex><span>        url <span style=color:#f92672>=</span> url_sanitizer(request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;url&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        buf <span style=color:#f92672>=</span> BytesIO()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            c <span style=color:#f92672>=</span> pycurl<span style=color:#f92672>.</span>Curl()
</span></span><span style=display:flex><span>            c<span style=color:#f92672>.</span>setopt(c<span style=color:#f92672>.</span>URL, url)
</span></span><span style=display:flex><span>            c<span style=color:#f92672>.</span>setopt(c<span style=color:#f92672>.</span>WRITEDATA, buf)
</span></span><span style=display:flex><span>            c<span style=color:#f92672>.</span>perform()
</span></span><span style=display:flex><span>            c<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>            body <span style=color:#f92672>=</span> buf<span style=color:#f92672>.</span>getvalue()<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>            print(body)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            print(e)
</span></span><span style=display:flex><span>            traceback<span style=color:#f92672>.</span>print_exc()
</span></span><span style=display:flex><span>            abort(<span style=color:#e6db74>&#34;error occurs&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;index.html&#34;</span>, url<span style=color:#f92672>=</span>url, data<span style=color:#f92672>=</span>response_sanitizer(body), name<span style=color:#f92672>=</span>name)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;index.html&#34;</span>, data<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, name<span style=color:#f92672>=</span>name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/register&#34;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;GET&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;register.html&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/register&#34;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;POST&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register_post</span>():
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;name&#34;</span>)
</span></span><span style=display:flex><span>    redis<span style=color:#f92672>.</span>set(id, json<span style=color:#f92672>.</span>dumps({<span style=color:#e6db74>&#34;id&#34;</span>: str(uuid<span style=color:#f92672>.</span>uuid4()), <span style=color:#e6db74>&#34;name&#34;</span>: name}))
</span></span><span style=display:flex><span>    redis<span style=color:#f92672>.</span>expire(id, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    resp <span style=color:#f92672>=</span> make_response(redirect(<span style=color:#e6db74>&#39;/&#39;</span>))
</span></span><span style=display:flex><span>    resp<span style=color:#f92672>.</span>set_cookie(<span style=color:#e6db74>&#39;__SESSION_ID&#39;</span>, id)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/logout&#34;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;GET&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>logout</span>():
</span></span><span style=display:flex><span>    resp <span style=color:#f92672>=</span> make_response(redirect(<span style=color:#e6db74>&#39;/&#39;</span>))
</span></span><span style=display:flex><span>    resp<span style=color:#f92672>.</span>set_cookie(<span style=color:#e6db74>&#39;__SESSION_ID&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, expires<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>run(debug<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>31555</span>)
</span></span></code></pre></div><p>以下の部分を見ると, インラインメモリデータストアであるredisにflagを格納していることがわかります.</p><pre tabindex=0><code class=language-:.pu data-lang=:.pu># initialization
redis = redis.Redis(host=&#39;redis&#39;, port=6379, db=0)
flag = &#34;TsukuCTF22{dummy flag}&#34; # the flag is replaced a real flag in a production environment.
id = str(uuid.uuid4())
redis.set(id, json.dumps({&#34;id&#34;: id, &#34;name&#34;: flag}))
</code></pre><p>また, 以下の部分を見ると, ユーザーから任意のURLを受け取ってそれを元にpycurlを用いてリクエストを送信し, レスポンスをhtmlにレンダリングすることがわかります.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.py data-lang=:.py><span style=display:flex><span><span style=color:#66d9ef>if</span> request<span style=color:#f92672>.</span>method <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;POST&#34;</span>:
</span></span><span style=display:flex><span>    url <span style=color:#f92672>=</span> url_sanitizer(request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;url&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    buf <span style=color:#f92672>=</span> BytesIO()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        c <span style=color:#f92672>=</span> pycurl<span style=color:#f92672>.</span>Curl()
</span></span><span style=display:flex><span>        c<span style=color:#f92672>.</span>setopt(c<span style=color:#f92672>.</span>URL, url)
</span></span><span style=display:flex><span>        c<span style=color:#f92672>.</span>setopt(c<span style=color:#f92672>.</span>WRITEDATA, buf)
</span></span><span style=display:flex><span>        c<span style=color:#f92672>.</span>perform()
</span></span><span style=display:flex><span>        c<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        body <span style=color:#f92672>=</span> buf<span style=color:#f92672>.</span>getvalue()<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>        print(body)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(e)
</span></span><span style=display:flex><span>        traceback<span style=color:#f92672>.</span>print_exc()
</span></span><span style=display:flex><span>        abort(<span style=color:#e6db74>&#34;error occurs&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;index.html&#34;</span>, url<span style=color:#f92672>=</span>url, data<span style=color:#f92672>=</span>response_sanitizer(body), name<span style=color:#f92672>=</span>name)
</span></span></code></pre></div><p>これらの情報から<a href=https://blog.tokumaru.org/2018/12/introduction-to-ssrf-server-side-request-forgery.html>SSRF</a>の脆弱性を用いて, redisからflagを取得するのだろうという予想を立てることができます.</p><p>しかし, ユーザーがPOSTするURLは以下のようにサニタイズされており, プロトコルがhttpまたはhttpsしか使用できないようです.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.py data-lang=:.py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>url_sanitizer</span>(uri: str) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(uri) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>or</span> any([scheme <span style=color:#f92672>in</span> uri <span style=color:#66d9ef>for</span> scheme <span style=color:#f92672>in</span> blacklist_of_scheme]):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;https://fans.sechack365.com&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> uri
</span></span></code></pre></div><p>調べると, Redisクライアントは<a href=http://mogile.web.fc2.com/redis/redis500/topics/protocol.html>RESP</a>プロトコルを用いてサーバを通信するようです. そして, curlがサポートしているプロトコルではtelnetやgopherを用いて通信ができるようですが, これらのプロトコルはサニタイズによって弾かれます. しかし, httpでも通信ができるという旨の<a href=https://www.agarri.fr/blog/archives/2014/09/11/trying_to_hack_redis_via_http_requests/index.html>記事</a>を発見したため, httpで通信する方向性で頑張っていましたが, 解けませんでした.</p><p>実際に解かれている方の<a href=https://nanimokangaeteinai.hateblo.jp/entry/2022/10/23/180703>writeup</a>を見ると, どうやらredisの最近のバージョンではhttpは使用できないようです（<a href=https://github.com/redis/redis/blob/6debeb3779fada89c82c1ffad3cf98fa48aa3b5d/src/networking.c#L3478-L3496>参考</a>）.</p><p>代わりに, URLのサニタイズ部分で小文字のチェックはしていますが, 大文字をまじえた文字列のチェックはしていないのでそれを利用して<a href=https://nanimokangaeteinai.hateblo.jp/entry/2022/10/23/180703#Web-500-viewer-8-solves>gopher</a>や<a href=https://blog.hamayanhamayan.com/entry/2022/10/23/181938#web-viewer>dict</a>などのプロトコルで通信し, flagをredisから抜き出すようです（詳細は割愛）.</p><h1 id=感想>感想</h1><p>OSINT中心のCTFでしたが, web問題もしっかり難易度が高くてとても勉強になりました. viewerのような歯応えのある問題をしっかり通せるように頑張りたいです.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/ctf>ctf</a></li><li><a href=/tags/writeup>writeup</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/melonattacker title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://x.com/melonattacker title=X><i data-feather=x></i></a>
<a class=border></a></div><div class=footer-info>2025 © yuasa | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>